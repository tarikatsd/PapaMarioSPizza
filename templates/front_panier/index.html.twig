{% extends 'base.html.twig' %}

{% block title %}
    Votre Panier
{% endblock %}

{% block body %}
    <h1 class="text-center mt-4">
        Votre panier
    </h1>
    <div class="mb-2">
    <a href="{{ path('app_front_pizza') }}" class="btn btn-orange">
    Continuer mes achats
    </a>
    </div>
    
    <table class="table table-index table-striped table-responsive">
        <thead>
            <tr>
                <th>Produits</th>
                <th>Suplements</th>
                <th>Prix</th>
                <th>Quantitées</th>
            </tr>
        </thead>
        {% if panier|length > 0 %}   
        <tbody>
            {% if pizzas|length > 0 %}
                {% for pizza in pizzas %}
                    <tr>
                        <td>
                            {{ pizza['pizza'].nom }}
                            </td>
                            <td>
                                {% for ingredient in pizza['ingredientsRemoved'] %}
                                    {{"-"}}{{ingredient.nom }}{{","}}
                                {% endfor %}
                                {% for ingredient in pizza['ingredientsAdded'] %}
                                {{"+"}}{{ ingredient.nom }}{{":"}}
                                    {{ ingredient.prix }}{{","}}
                                {% endfor %}
                            </td>
                            <td class="total-price">
                                {{ pizza['totalPrice'] }}
                            </td>
                            
                            <td>
                                <input type="number" class="quantity" value="{{ pizza['quantity'] }}" min="0" max="20" data-price="{{ pizza['totalPrice'] }}" data-item-id="{{ pizza['uniqueKey'] }}">
                            </td>
                        </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        <tbody>
            {% if canettes|length > 0 %}
                {% for canette in canettes %}
                    <tr>
                        <td>
                            {{ canette['canette'].nom }} : {{ canette['canette'].taille }}
                        </td>
                        <td>
                        </td>
                        <td class="total-price">
                            {{ canette['totalPrice'] }}
                        </td>
                        <td>
                            <input type="number" class="quantity" value="{{ canette['quantity'] }}" data-item-id="{{ canette['canette'].id ~ "_" ~ canette['canette'].nom }}" min="0" max="20" data-price="{{ canette['totalPrice'] }}">
                        </td>
                    </tr>
                {% endfor %}
            {% endif %}
        </tbody>
        <tbody>
            {% if boissons|length > 0 %}
                {% for boisson in boissons %}
                    <tr>
                        <td>
                            {{ boisson['boisson'].nom }} : {{ boisson['boisson'].taille }}
                        </td>
                        <td>
                        </td>
                        <td class="total-price">
                            {{ boisson['totalPrice'] }}
                        </td>
                        <td>
                            <input type="number" class="quantity" value="{{ boisson['quantity'] }}" data-item-id="{{ boisson['boisson'].id ~ "_" ~ boisson['boisson'].nom }}" min="0" max="20" data-price="{{ boisson['totalPrice'] }}">
                        </td>
                    </tr>
                {% endfor %}
            {% endif %}

        </tbody>
        <tbody>
            {% if desserts|length > 0 %}
                {% for dessert in desserts %}
                    <tr>
                        <td>
                            {{ dessert['dessert'].nom }}
                        </td>
                        <td>
                        </td>
                        <td class="total-price">
                            {{ dessert['totalPrice'] }}
                        </td>
                        <td>
                            <input type="number" class="quantity" value="{{ dessert['quantity'] }}" data-item-id="{{ dessert['dessert'].id ~ "_" ~ dessert['dessert'].nom }}" min="0" max="20" data-price="{{ dessert['totalPrice'] }}">
                        </td>
                    </tr>
                {% endfor %}
            {% endif %}
        </tbody>
        <tbody>
            {% if extras|length > 0 %}
                {% for extra in extras %}
                    <tr>
                        <td>
                            {{ extra['extra'].nom }}
                        </td>
                        <td>
                        </td>
                        <td class="total-price">
                            {{ extra['totalPrice'] }}
                        </td>
                        <td>
                            <input type="number" class="quantity" value="{{ extra['quantity'] }}"data-item-id="{{ extra['extra'].id ~ "_" ~ extra['extra'].nom }}" min="0" max="20" data-price="{{extra['totalPrice'] }}">
                        </td>
                    </tr>
                {% endfor %}
            {% endif %}
        </tbody>        
        <tfoot>
            <tr>
                <td class=" text-center fw-bold">
                    Total
                </td>
                <td id="total" colspan="2" class=" text-center fw-bold">
                    0.00
                </td>
                <td>
                    <a href={{ path('app_front_commande')}} class="btn btn-brown">
                        Commander
                    </a>
                </td>
        </tr>
    </tfoot>
    {% else %}
    <tbody>
        <tr>
            <td colspan="4" class="text-start">
                Votre panier est vide
            </td>
        </tr>
    {% endif %}
</table>
    {% endblock %}
    {% block javascripts %}
    <script>
document.addEventListener("DOMContentLoaded", function() {
    // Appelez la fonction updateTotal initialement pour afficher le total initial
    updateTotal();
});

    // Fonction pour mettre à jour le total
    function updateTotal() {
        let total = 0;
    
        // Parcourez les entrées de quantité et calculez le total mis à jour
        const quantityInputs = document.querySelectorAll('.quantity');
        quantityInputs.forEach(input => {
            const price = parseFloat(input.getAttribute('data-price'));
            let quantity = parseInt(input.value);
    
            // Vérifiez si la quantité est égale à zéro
            if (quantity == 0) {
                quantity = 1;
                // Affichez une boîte de dialogue de confirmation
                const confirmDelete = confirm("Voulez-vous supprimer cet article du panier ?");
                if (confirmDelete) {
                    // Supprimez l'élément du panier
                    input.parentElement.parentElement.remove();
                }
            }
    
            // Mettez à jour le champ de quantité avec la nouvelle quantité (peut être 0)
            input.value = quantity;
    
            // Mettez à jour le prix total de l'article en fonction de la quantité
            const totalCell = input.parentElement.parentElement.querySelector('.total-price');
            totalCell.textContent = (price * quantity).toFixed(2);
    
            // Ajoutez le prix de cet article au total général
            total += price * quantity;
        });
    
        // Mettez à jour la cellule du total avec le total calculé
        const totalCell = document.getElementById('total');
        totalCell.textContent = total.toFixed(2);
    }
    
    // Attachez des écouteurs d'événements aux entrées de quantité
    const quantityInputs = document.querySelectorAll('.quantity');
    quantityInputs.forEach(input => {
        input.addEventListener('input', updateTotal);
        const itemId = input.getAttribute('data-item-id');
    });
    // Fonction pour envoyer une requête AJAX pour mettre à jour la session du panier
    function updateCart(itemId, newQuantity) {
        event.preventDefault();
        event.stopPropagation();
        // Utilisez jQuery pour envoyer la requête AJAX
        $.ajax({
            type: 'POST', // Méthode HTTP POST
            url: '/update/panier', // L'URL de votre route Symfony pour la mise à jour du panier
            data: {
                itemId: itemId,
                newQuantity: newQuantity
            }, // Les données à envoyer au serveur
            dataType: 'json', // Le type de données attendu en réponse
            success: function(data) {
                if (data.success) {
                    // La mise à jour du panier a réussi, faites ce que vous devez faire
                    console.log('Mise à jour du panier réussie !');
                } else {
                    // La mise à jour du panier a échoué, gérer les erreurs si nécessaire
                    console.error('Échec de la mise à jour du panier.');
                }
            },
            error: function(xhr, textStatus, errorThrown) {
                // Gérer les erreurs de la requête AJAX
                console.error('Erreur lors de la requête AJAX : ' + textStatus, errorThrown);
            }
        });
    }
    
    // Attachez des écouteurs d'événements aux entrées de quantité pour déclencher la mise à jour du panier
    quantityInputs.forEach(input => {
        input.addEventListener('change', function() {
            const itemId = input.getAttribute('data-item-id');
            const newQuantity = input.value;
            updateCart(itemId, newQuantity);
        });
    });
    
</script>
{% endblock %}
